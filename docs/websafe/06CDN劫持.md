# CDN劫持

## CDN原理？

它的名字就叫做`CDN`——**Content Delivery Network**，内容分发网络。具体来说，`CDN`就是采用更多的缓存服务器（CDN边缘节点），布放在用户访问相对集中的地区或网络中。当用户访问网站时，利用全局负载技术，将用户的访问指向距离最近的缓存服务器上，由缓存服务器响应用户请求。（有点像电商的本地仓吧？）CDN应用广泛，支持多种行业、多种场景内容加速，例如：图片小文件、大文件下载、视音频点播、直播流媒体、全站加速、安全加速。

## 什么是CDN劫持？

网络上有很多黑客为了让用户能够登录自己开发的钓鱼网站，都会通过对CDN进行劫持的方法，让用户自动转入自己开发的网站。而很多用户却往往无法察觉到自己已经被劫持。其实验证被劫持的方法，就是输入任何网址看看所打开的网页是否和自己输入的网址一致，

1. 域名解析劫持：黑客可能通过攻击域名解析服务器（DNS服务器），修改域名解析的结果。当用户在浏览器中输入网站地址时，浏览器会向DNS服务器请求解析域名对应的IP地址。黑客可以通过篡改DNS响应，将原本指向正常CDN服务器的域名解析结果替换为指向黑客控制的服务器的IP地址。这样一来，用户在访问网站时，实际上会请求黑客控制的服务器，从而加载被篡改的资源。
2. 网络传输劫持：黑客可能在网站和CDN服务器之间的网络传输过程中进行攻击。他们可能通过中间人攻击、DNS劫持、BGP劫持等方式，篡改用户与CDN服务器之间的通信，将原本应该返回的正常资源替换为恶意或篡改过的资源。这种劫持可能发生在用户与CDN之间的任何网络节点上。

## CDN劫持防范措施

### 使用SRI来解决CDN劫持

**SRI** 全称 Subresource Integrity - 子资源完整性，是指浏览器通过验证资源的完整性（通常从 CDN 获取）来判断其是否被篡改的安全特性。

通过给 link 标签或者 script 标签增加 integrity 属性即可开启 SRI 功能，比如

```html
<script 
    type="text/javascript" 
    src="//s.url.cn/xxxx/aaa.js" 
    integrity="sha256-xxx sha384-yyy"
    crossorigin="anonymous"></script>
```

integrity 值分成两个部分，第一部分指定哈希值的生成算法（sha256、sha384 及 sha512），第二部分是经过 base64 编码的实际哈希值，两者之间通过一个短横（-）分割。integrity 值可以包含多个由空格分隔的哈希值，只要文件匹配其中任意一个哈希值，就可以通过校验并加载该资源。**开启 SRI 能有效保证页面引用资源的完整性，避免恶意代码执行。**

## SRI工作原理

1. 生成摘要：在服务器端，使用指定的哈希算法（如 SHA-256、SHA-384、SHA-512）对资源文件进行摘要计算。这个摘要是一个固定长度的字符串，代表了资源文件的内容。

2. 添加摘要：将资源文件的摘要添加到页面或外部引用的标签中，使用 `integrity` 属性。例如，在 `<script>` 或 `<link>` 标签中添加 `integrity` 属性，值为 `sha256-xxxxx`，其中 `sha256` 表示使用 SHA-256 算法，`xxxxx` 是资源文件的摘要。

3. 验证摘要：当浏览器加载或执行资源时，它会使用相同的哈希算法对资源进行计算，并将计算得到的摘要与 `integrity` 属性中指定的摘要进行比较。

   > 验证摘要的流程和原理
   >
   > 1. 资源加载：浏览器在加载页面时，会解析 HTML 文件中的资源标签（如 `<script>`、`<link>`、`<img>` 等），并开始加载这些资源。
   > 2. 摘要提取：当浏览器遇到具有 `integrity` 属性的资源标签时，它会提取标签中的摘要值。
   > 3. 资源下载：浏览器继续下载资源文件，将其保存在内存中或者存储在缓存中。
   > 4. 摘要计算：在资源下载完成后，浏览器使用与 `integrity` 属性中指定的哈希算法相同的算法，对下载的资源进行摘要计算。
   > 5. 摘要比对：浏览器将计算得到的摘要与标签中的摘要值进行比对。
   >       - 如果两者匹配，浏览器会确认资源的完整性，认为资源未被篡改，并继续处理该资源。
   >       - 如果两者不匹配，浏览器会发出安全警告，并拒绝加载或执行该资源。资源的加载过程会被中止，浏览器将不会使用被篡改的资源。
   
   

### 添加摘要的方式

1. 手动添加：如果你手动编写网页代码，你可以手动在标签中添加 `integrity` 属性，并将生成的摘要作为属性值。例如：
```html
<script src="path/to/script.js" integrity="sha256-xxxxx"></script>
<link href="path/to/styles.css" rel="stylesheet" integrity="sha256-xxxxx">
```
在这种情况下，你需要自行生成摘要并将其添加到对应的标签中。


2. 构建工具：许多前端构建工具（如Webpack、Parcel、Gulp等）提供了插件或功能来自动计算并添加 SRI 摘要。这些工具可以在构建过程中自动为资源生成摘要，并将摘要添加到生成的 HTML 文件中。webpack提供了插件（如 `webpack-subresource-integrity`）来计算和添加 SRI 摘要。
3. 内容分发网络（CDN）：如果你使用内容分发网络来托管你的资源文件，一些 CDN 提供商可以为你自动生成 SRI 摘要，并将摘要添加到引用的资源标签中。你可以在 CDN 的文档中查找相关信息，了解如何启用和配置 SRI 功能。



### 浏览器如何处理 SRI

- 当浏览器在 script 或者 link 标签中遇到 integrity 属性之后，会在执行脚本或者应用样式表之前对比所加载文件的哈希值和期望的哈希值。
- 当脚本或者样式表的哈希值和期望的不一致时，浏览器必须拒绝执行脚本或者应用样式表，并且必须返回一个网络错误说明获得脚本或样式表失败。